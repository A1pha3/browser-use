---
title: "Playwright é›†æˆ"
description: "é«˜çº§ç¤ºä¾‹ï¼Œå±•ç¤º Playwright å’Œ Browser-Use å¦‚ä½•ååŒå·¥ä½œã€‚"
icon: "wand-magic-sparkles"
mode: "wide"
---

## ä¸»è¦ç‰¹æ€§

1. Browser-Use å’Œ Playwright é€šè¿‡ CDP å…±äº«åŒä¸€ä¸ª Chrome å®ä¾‹
2. ä½¿ç”¨ Playwright æ‰§è¡Œæ“ä½œï¼Œç»§ç»­ä½¿ç”¨ Browser-Use æ“ä½œ
3. è®©ä»£ç†è°ƒç”¨ Playwright å‡½æ•°ï¼ˆå¦‚æˆªå›¾æˆ–ç‚¹å‡»é€‰æ‹©å™¨ï¼‰è¿›è¡Œç¡®å®šæ€§æ­¥éª¤

## å®‰è£…

```bash
uv pip install playwright aiohttp
```

## å®Œæ•´ç¤ºä¾‹

```python
import asyncio
import os
import subprocess
import sys
import tempfile

from pydantic import BaseModel, Field

# å…ˆæ£€æŸ¥å¿…éœ€çš„ä¾èµ–
try:
    import aiohttp
    from playwright.async_api import Browser, Page, async_playwright
except ImportError as e:
    print(f'âŒ æ­¤ç¤ºä¾‹ç¼ºå°‘ä¾èµ–ï¼š{e}')
    print('éœ€è¦ï¼šplaywright aiohttp')
    print('å®‰è£…ï¼šuv add playwright aiohttp')
    print('åŒæ—¶è¿è¡Œï¼šplaywright install chromium')
    sys.exit(1)

from browser_use import Agent, BrowserSession, ChatOpenAI, Tools
from browser_use.agent.views import ActionResult

# å…¨å±€ Playwright æµè§ˆå™¨å®ä¾‹ - åœ¨è‡ªå®šä¹‰æ“ä½œä¹‹é—´å…±äº«
playwright_browser: Browser | None = None
playwright_page: Page | None = None

# è‡ªå®šä¹‰æ“ä½œå‚æ•°æ¨¡å‹
class PlaywrightFillFormAction(BaseModel):
    """Playwright è¡¨å•å¡«å†™æ“ä½œçš„å‚æ•°ã€‚"""
    customer_name: str = Field(..., description='è¦å¡«å†™çš„å®¢æˆ·åç§°')
    phone_number: str = Field(..., description='è¦å¡«å†™çš„ç”µè¯å·ç ')
    email: str = Field(..., description='è¦å¡«å†™çš„ç”µå­é‚®ä»¶åœ°å€')
    size_option: str = Field(..., description='å°ºå¯¸é€‰é¡¹ï¼ˆsmall/medium/largeï¼‰')

class PlaywrightScreenshotAction(BaseModel):
    """Playwright æˆªå›¾æ“ä½œçš„å‚æ•°ã€‚"""
    filename: str = Field(default='playwright_screenshot.png', description='æˆªå›¾æ–‡ä»¶å')
    quality: int | None = Field(default=None, description='JPEG è´¨é‡ï¼ˆ1-100ï¼‰ï¼Œä»…é€‚ç”¨äº .jpg/.jpeg æ–‡ä»¶')

class PlaywrightGetTextAction(BaseModel):
    """ä½¿ç”¨ Playwright é€‰æ‹©å™¨è·å–æ–‡æœ¬çš„å‚æ•°ã€‚"""
    selector: str = Field(..., description='è¦è·å–æ–‡æœ¬çš„ CSS é€‰æ‹©å™¨ã€‚ä½¿ç”¨"title"è·å–é¡µé¢æ ‡é¢˜ã€‚')

async def start_chrome_with_debug_port(port: int = 9222):
    """å¯åŠ¨å¯ç”¨äº†è¿œç¨‹è°ƒè¯•çš„ Chromeã€‚"""
    user_data_dir = tempfile.mkdtemp(prefix='chrome_cdp_')
    
    # Chrome å¯åŠ¨å‘½ä»¤
    chrome_paths = [
        '/Applications/Google Chrome.app/Contents/MacOS/Google Chrome',
        '/usr/bin/google-chrome',
        '/usr/bin/chromium-browser',
        'chrome',
        'chromium',
    ]
    
    chrome_exe = None
    for path in chrome_paths:
        if os.path.exists(path) or path in ['chrome', 'chromium']:
            try:
                test_proc = await asyncio.create_subprocess_exec(
                    path, '--version', stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL
                )
                await test_proc.wait()
                chrome_exe = path
                break
            except Exception:
                continue
    
    if not chrome_exe:
        raise RuntimeError('âŒ æœªæ‰¾åˆ° Chromeã€‚è¯·å®‰è£… Chrome æˆ– Chromiumã€‚')
    
    cmd = [
        chrome_exe,
        f'--remote-debugging-port={port}',
        f'--user-data-dir={user_data_dir}',
        '--no-first-run',
        '--no-default-browser-check',
        '--disable-extensions',
        'about:blank',
    ]
    
    process = await asyncio.create_subprocess_exec(*cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    
    # ç­‰å¾… Chrome å¯åŠ¨å’Œ CDP å°±ç»ª
    cdp_ready = False
    for _ in range(20):  # 20 ç§’è¶…æ—¶
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(
                    f'http://localhost:{port}/json/version', timeout=aiohttp.ClientTimeout(total=1)
                ) as response:
                    if response.status == 200:
                        cdp_ready = True
                        break
        except Exception:
            pass
        await asyncio.sleep(1)
    
    if not cdp_ready:
        process.terminate()
        raise RuntimeError('âŒ Chrome æ— æ³•ä»¥ CDP æ¨¡å¼å¯åŠ¨')
    
    return process

async def connect_playwright_to_cdp(cdp_url: str):
    """å°† Playwright è¿æ¥åˆ° Browser-Use ä½¿ç”¨çš„åŒä¸€ä¸ª Chrome å®ä¾‹ã€‚"""
    global playwright_browser, playwright_page
    
    playwright = await async_playwright().start()
    playwright_browser = await playwright.chromium.connect_over_cdp(cdp_url)
    
    if playwright_browser and playwright_browser.contexts and playwright_browser.contexts[0].pages:
        playwright_page = playwright_browser.contexts[0].pages[0]
    elif playwright_browser:
        context = await playwright_browser.new_context()
        playwright_page = await context.new_page()

# åˆ›å»ºä½¿ç”¨ Playwright å‡½æ•°çš„è‡ªå®šä¹‰å·¥å…·
tools = Tools()

@tools.registry.action(
    "ä½¿ç”¨ Playwright çš„ç²¾ç¡®è¡¨å•å¡«å†™åŠŸèƒ½å¡«å†™è¡¨å•ã€‚è¿™ä½¿ç”¨ Playwright é€‰æ‹©å™¨è¿›è¡Œå¯é çš„è¡¨å•äº¤äº’ã€‚",
    param_model=PlaywrightFillFormAction,
)
async def playwright_fill_form(params: PlaywrightFillFormAction, browser_session: BrowserSession):
    """ä½¿ç”¨ Playwright é«˜ç²¾åº¦å¡«å†™è¡¨å•çš„è‡ªå®šä¹‰æ“ä½œã€‚"""
    try:
        if not playwright_page:
            return ActionResult(error='Playwright æœªè¿æ¥ã€‚è¯·å…ˆè¿è¡Œè®¾ç½®ã€‚')
        
        await playwright_page.wait_for_selector('input[name="custname"]', timeout=10000)
        await playwright_page.fill('input[name="custname"]', params.customer_name)
        await playwright_page.fill('input[name="custtel"]', params.phone_number)
        await playwright_page.fill('input[name="custemail"]', params.email)
        
        # å¤„ç†å°ºå¯¸é€‰æ‹©
        size_select = playwright_page.locator('select[name="size"]')
        size_radio = playwright_page.locator(f'input[name="size"][value="{params.size_option}"]')
        
        if await size_select.count() > 0:
            await playwright_page.select_option('select[name="size"]', params.size_option)
        elif await size_radio.count() > 0:
            await playwright_page.check(f'input[name="size"][value="{params.size_option}"]')
        
        form_data = {}
        form_data['name'] = await playwright_page.input_value('input[name="custname"]')
        form_data['phone'] = await playwright_page.input_value('input[name="custtel"]')
        form_data['email'] = await playwright_page.input_value('input[name="custemail"]')
        
        success_msg = f'âœ… ä½¿ç”¨ Playwright æˆåŠŸå¡«å†™è¡¨å•ï¼š{form_data}'
        return ActionResult(
            extracted_content=success_msg, include_in_memory=True, long_term_memory=f'å¡«å†™çš„è¡¨å•ï¼š{form_data}'
        )
    
    except Exception as e:
        error_msg = f'âŒ Playwright è¡¨å•å¡«å†™å¤±è´¥ï¼š{str(e)}'
        return ActionResult(error=error_msg)

@tools.registry.action(
    "ä½¿ç”¨ Playwright çš„æˆªå›¾åŠŸèƒ½ä»¥é«˜è´¨é‡å’Œé«˜ç²¾åº¦è¿›è¡Œæˆªå›¾ã€‚",
    param_model=PlaywrightScreenshotAction,
)
async def playwright_screenshot(params: PlaywrightScreenshotAction, browser_session: BrowserSession):
    """ä½¿ç”¨ Playwright é«˜çº§æˆªå›¾åŠŸèƒ½ã€‚"""
    try:
        if not playwright_page:
            return ActionResult(error='Playwright æœªè¿æ¥ã€‚')
        
        screenshot_kwargs = {'path': params.filename, 'full_page': True}
        if params.quality is not None and params.filename.lower().endswith(('.jpg', '.jpeg')):
            screenshot_kwargs['quality'] = params.quality
        
        await playwright_page.screenshot(**screenshot_kwargs)
        
        success_msg = f'âœ… ä½¿ç”¨ Playwright å°†æˆªå›¾ä¿å­˜ä¸º {params.filename}'
        return ActionResult(
            extracted_content=success_msg, include_in_memory=True, long_term_memory=f'æˆªå›¾ä¿å­˜ï¼š{params.filename}'
        )
    
    except Exception as e:
        error_msg = f'âŒ Playwright æˆªå›¾å¤±è´¥ï¼š{str(e)}'
        return ActionResult(error=error_msg)

async def main():
    """æ¼”ç¤º Browser-Use + Playwright é›†æˆçš„ä¸»å‡½æ•°ã€‚"""
    print('ğŸš€ é«˜çº§ Playwright + Browser-Use é›†æˆæ¼”ç¤º')
    
    chrome_process = None
    try:
        # æ­¥éª¤ 1ï¼šå¯åŠ¨å¸¦ CDP è°ƒè¯•çš„ Chrome
        chrome_process = await start_chrome_with_debug_port()
        cdp_url = 'http://localhost:9222'
        
        # æ­¥éª¤ 2ï¼šå°† Playwright è¿æ¥åˆ°åŒä¸€ä¸ª Chrome å®ä¾‹
        await connect_playwright_to_cdp(cdp_url)
        
        # æ­¥éª¤ 3ï¼šåˆ›å»ºè¿æ¥åˆ°åŒä¸€ä¸ª Chrome çš„ Browser-Use ä¼šè¯
        browser_session = BrowserSession(cdp_url=cdp_url)
        
        # æ­¥éª¤ 4ï¼šåˆ›å»ºå¸¦æœ‰æˆ‘ä»¬çš„ Playwright é©±åŠ¨å·¥å…·çš„ AI ä»£ç†
        agent = Agent(
            task="""
            è¯·å¸®æˆ‘æ¼”ç¤º Browser-Use å’Œ Playwright ä¹‹é—´çš„é›†æˆï¼š
            
            1. é¦–å…ˆï¼Œå¯¼èˆªåˆ° https://httpbin.org/forms/post
            2. ä½¿ç”¨ 'playwright_fill_form' æ“ä½œå¡«å†™è¡¨å•ï¼š
               - å®¢æˆ·åç§°ï¼š"Alice Johnson"
               - ç”µè¯ï¼š"555-9876"
               - é‚®ç®±ï¼š"alice@demo.com"
               - å°ºå¯¸ï¼š"large"
            3. ä½¿ç”¨ 'playwright_screenshot' æ“ä½œæˆªå›¾å¹¶ä¿å­˜ä¸º "form_demo.png"
            4. ä½¿ç”¨ 'playwright_get_text' æ“ä½œä½¿ç”¨é€‰æ‹©å™¨ "title" æå–é¡µé¢æ ‡é¢˜
            5. æœ€åï¼Œæäº¤è¡¨å•å¹¶å‘Šè¯‰æˆ‘å‘ç”Ÿäº†ä»€ä¹ˆ
            
            è¿™æ¼”ç¤ºäº† Browser-Use AI å¦‚ä½•ç¼–æ’ä»»åŠ¡ï¼ŒåŒæ—¶ä½¿ç”¨ Playwright çš„ç²¾ç¡®åŠŸèƒ½è¿›è¡Œç‰¹å®šæ“ä½œã€‚
            """,
            llm=ChatOpenAI(model='gpt-4.1-mini'),
            tools=tools,
            browser_session=browser_session,
        )
        
        print('ğŸ¯ å¯åŠ¨å¸¦æœ‰è‡ªå®šä¹‰ Playwright æ“ä½œçš„ AI ä»£ç†...')
        
        # æ­¥éª¤ 5ï¼šè¿è¡Œä»£ç† - å®ƒå°†åŒæ—¶ä½¿ç”¨ Browser-Use æ“ä½œå’Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ Playwright æ“ä½œ
        result = await agent.run()
        
        print(f'âœ… é›†æˆæ¼”ç¤ºå®Œæˆï¼ç»“æœï¼š{result}')
        await asyncio.sleep(2)
    
    except Exception as e:
        print(f'âŒ é”™è¯¯ï¼š{e}')
        raise
    
    finally:
        # æ¸…ç†èµ„æº
        if playwright_browser:
            await playwright_browser.close()
        
        if chrome_process:
            chrome_process.terminate()
            try:
                await asyncio.wait_for(chrome_process.wait(), 5)
            except TimeoutError:
                chrome_process.kill()
        
        print('âœ… æ¸…ç†å®Œæˆ')

if __name__ == '__main__':
    asyncio.run(main())
```

## ç›¸å…³èµ„æº

- [Playwright å®˜æ–¹æ–‡æ¡£](https://playwright.dev/)
- [è‡ªå®šä¹‰å·¥å…·](/customize/tools/add.mdx)
- [å·¥å…·åŸºç¡€](/customize/tools/basics.mdx)
